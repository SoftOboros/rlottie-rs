# rlottie‑rs Contributor / Agent Guide

This document defines the **hard rules** for every bot, CI job, or human contributing code to *rlottie‑rs*. Follow it verbatim to keep the pipeline green and the crate publish‑able.

---

## 1 Workflow Overview

1. Fork → feature branch → **pull request**.
2. GitHub Actions runs the full matrix (see `/doc/TODO.md §9`).
3. All checks **must** pass before merge.
4. Maintainer merges → `main` → auto‑publish docs + artefacts.

---

## 2 Mandatory CI Steps

| Step       | Tool / command                                    | Failure condition |                         |
| ---------- | ------------------------------------------------- | ----------------- | ----------------------- |
| **fmt**    | `cargo fmt --all -- --check`                      | Any diff produced |                         |
| **check**  | `cargo check --all-features --workspace` (stable) | Error exit code   |                         |
| **clippy** | `cargo clippy --all-features -- -D warnings`      | Any warning       |                         |
| **test**   | `cargo test --all-features`                       | Test failure      |                         |
| **doc**    | `cargo +nightly doc --all-features --no-deps`     | rustdoc error     |                         |
| **size**   | \`cargo bloat -n 0                                | grep TOTAL\`      | >600 kB for `thumbv7em` |
| **hash**   | `tests/golden_hash.rs`                            | SHA‑256 mismatch  |                         |
| **fuzz**   | nightly cron job                                  | Crash or OOM      |                         |

*Agents* must replicate these commands locally before pushing.

---

## 3 Coding Standards

### 3.1 Public API

- Every **public** `mod`, `fn`, `struct`, `enum`, `trait`, and field **must** have a /// doc‑comment.
- Top‑level modules should embed MD docs:\
  `#![doc = include_str!("../../README.md")]`

### 3.2 Naming & Parity

| Rule                                               | Example                                                     |
| -------------------------------------------------- | ----------------------------------------------------------- |
| Mirror C++ names, rustified                        | C++ `Animation::renderSync` ⇒ Rust `Animation::render_sync` |
| Use `CamelCase` types, `snake_case` fns            | `ShapeLayer`, `sample_frame`                                |
| Preserve rlottie file/dir hierarchy where sensible | `shape/`, `model/`, `render/`                               |

> **Design rule:** *If in doubt, inspect the C++ source first.*  Behaviour and default values **must** match upstream unless unclearly specified, then open an issue.

### 3.3 File Headers

Every source file **MUST** start with:

```rust
//! Module: <short description>
//! Mirrors: rlottie/<path>/<file>.cc
```

---

## 4 Tests & Reference Data

- All golden images, JSON fixtures, and hashes are generated by the **C++ rlottie submodule** (see `/rlottie`).
- Do **not** regenerate Rust‑side artefacts unless the C++ baseline changes.
- Unit tests live beside code (`#[cfg(test)]`).  Integration tests go under `/tests/`.

---

## 5 Crates.io Publishing

Release happens manually after a **tag** push:

```bash
# 1. Bump version in root & crate Cargo.toml files
# 2. Ensure CHANGELOG entry
cargo publish --workspace --dry-run      # must succeed
cargo publish --workspace --allow-dirty  # CI does clean build anyway
```

- `package.metadata.docs.rs` must list **all-features** and `rustdoc-args`.
- Remember to push **tags**: `git push --tags`.

---

## 6 Licence Notice

All new files **must** carry the header:

```text
// Copyright © SoftOboros Technology, Inc.
// SPDX‑License‑Identifier: MIT
```

---

## 7 Codex Agent Behavior

The loop runner agent operates as follows:

1. Load `/doc/TODO.md`. Start from the top. For each item:
   - If it is not checked off (`[ ]`), proceed.
   - If checked (`[x]`), skip.

2. **Implement the required feature** in Rust based on the C++ rlottie source:
   - Use the matching file path under `/rlottie/` as your reference.
   - Match behavior and signatures first — not Rust conventions.
   - Preserve default values and logic from the C++ side.

3. **Validate with golden test expectations**:
   - Run `cargo test --all-features`.
   - Confirm output matches the expected C++ behavior.
   - If the test fails, retry implementation once.
   - Do not assume the Rust implementation is correct.

4. **Mark the task complete** by checking the box in `TODO.md`.

5. Repeat until all items in `TODO.md` are complete.

6. Switch to `/doc/TODO-TESTING.md` and repeat steps 1–5 for test cases.

**Important rules:**

- Do not infer behavior from other Rust modules. Trust the C++ source.
- If C++ logic is unclear or unstable, skip the item and flag it with `⚠️ Needs upstream clarification`.
- Do not touch publishing or CI setup unless explicitly told.

---

## TL;DR Checklist

Before opening a PR, run:

```bash
cargo fmt --all
cargo clippy --all-features -- -D warnings
cargo test --all-features
cargo +nightly doc --all-features --no-deps
.
```

If everything is green, push and open the pull request—CI will do the rest.

